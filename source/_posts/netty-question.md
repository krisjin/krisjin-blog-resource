title: 学习Netty的11个疑问
date: 2015-03-12 14:24:24
categories: netty
tags: [netty]
---


Netty是一个基于JAVA NIO类库的异步通信框架，它的架构特点是：异步非阻塞、基于事件驱动、高性能、高可靠性和高可定制性。<!--more-->

## 1.使用Netty能够做什么
---

- 开发异步、非阻塞的TCP网络应用程序；
- 开发异步、非阻塞的UDP网络应用程序；
- 开发异步文件传输应用程序；
- 开发异步HTTP服务端和客户端应用程序；
- 提供对多种编解码框架的集成，包括谷歌的Protobuf、Jbossmarshalling、Java序列化、压缩编解码、XML解码、字符串编解码等，这些编解码框架可以被用户直接使用；
- 提供形式多样的编解码基础类库，可以非常方便的实现私有协议栈编解码框架的二次定制和开发；
- 基于职责链模式的Pipeline-Handler机制，用户可以非常方便的对网络事件进行拦截和定制； 
- 所有的IO操作都是异步的，用户可以通过Future-Listener机制主动Get结果或者由IO线程操作完成之后主动Notify结果，用户的业务线程不需要同步等待；
- IP黑白名单控制；
- 打印消息码流；
- 流量控制和整形；
- 性能统计；
- 基于链路空闲事件检测的心跳检测
- ……

## 2.Netty在那些行业得到了应用
---

**1. 互联网行业**：随着网站规模的不断扩大，系统并发访问量也越来越高，传统基于Tomcat等Web容器的垂直架构已经无法满足需求，需要拆分应用进行服务化，以提高开发和维护效率。从组网情况看，垂直的架构拆分之后，系统采用分布式部署，各个节点之间需要远程服务调用，高性能的RPC框架必不可少，Netty作为异步高性能的通信框架，往往作为基础通信组件被这些RPC框架使用。

典型的应用有：阿里分布式服务框架Dubbo的RPC框架使用Dubbo协议进行节点间通信，Dubbo协议默认使用Netty作为基础通信组件，用于实现各进程节点之间的内部通信。它的架构图如下：

![](/img/dubbo-netty.png)  
上图是：Dubbo节点间调用关系图

其中，服务提供者和服务消费者之间，服务提供者、服务消费者和性能统计节点之间使用Netty进行异步/同步通信。
除了Dubbo之外，淘宝的消息中间件RocketMQ的消息生产者和消息消费者之间，也采用Netty进行高性能、异步通信。
除了阿里系和淘宝系之外，很多其它的大型互联网公司或者电商内部也已经大量使用Netty构建高性能、分布式的网络服务器。

**2. 游戏行业**：无论是手游服务端、还是大型的网络游戏，Java语言得到了越来越广泛的应用。Netty作为高性能的基础通信组件，它本身提供了TCP/UDP和HTTP协议栈，非常方便定制和开发私有协议栈。账号登陆服务器、地图服务器之间可以方便的通过Netty进行高性能的通信，架构示意图如下：

![](/img/netty-player.png)  
上图是：Netty在游戏服务器架构中的应用

**3. 大数据领域**：经典的Hadoop的高性能通信和序列化组件Avro的RPC框架，默认采用Netty进行跨节点通信，它的Netty Service基于Netty框架二次封装实现。  
大数据计算往往采用多个计算节点和一个/N个汇总节点进行分布式部署，各节点之间存在海量的数据交换。由于Netty的综合性能是目前各个成熟NIO框架中最高的，因此，往往会被选中用作大数据各节点间的通信。

**4. 企业软件**：企业和IT集成需要ESB，Netty对多协议支持、私有协议定制的简洁性和高性能是ESB RPC框架的首选通信组件。事实上，很多企业总线厂商会选择Netty作为基础通信组件，用于企业的IT集成。

**5. 通信行业**：Netty的异步高性能、高可靠性和高成熟度的优点，使它在通信行业得到了大量的应用。

## 3.使用传统的Socket开发挺简单的，我为什么要切换到NIO进行编程呢  
---

首先我们看下传统基于同步阻塞IO（BIO）的线程模型图：

![](/img/synchronize.png)  
上图是：同步阻塞IO（BIO）线程模型图  

由上图我们可以看出，传统的同步阻塞IO通信存在如下几个问题：

- 线程模型存在致命缺陷：一连接一线程的模型导致服务端无法承受大量客户端的并发连接
- 性能差：频繁的线程上下文切换导致CPU利用效率不高
- 可靠性差：由于所有的IO操作都是同步的，所以业务线程只要进行IO操作，也会存在被同步阻塞的风险，这会导致系统的可靠性差，依赖外部组件的处理能力和网络的情况

采用非阻塞IO（NIO）之后，同步阻塞IO的三个缺陷都将迎刃而解：

- Nio采用Reactor模式，一个Reactor线程聚合一个多路复用器Selector，它可以同时注册、监听和轮询成百上千个Channel，一个IO线程可以同时并发处理N个客户端连接，线程模型优化为1：N（N < 进程可用的最大句柄数）或者M : N (M通常为CPU核数  + 1， N < 进程可用的最大句柄数)
- 由于IO线程总数有限，不会存在频繁的IO线程之间上下文切换和竞争，CPU利用率高
- 所有的IO操作都是异步的，即使业务线程直接进行IO操作，也不会被同步阻塞，系统不再依赖外部的网络环境和外部应用程序的处理性能

由于切换到NIO编程之后可以为系统带来巨大的可靠性、性能提升，所以，目前采用NIO进行通信已经逐渐成为主流

## 4.为什么不直接基于JDK的NIO类库编程呢
---
我们通过JDK NIO服务端和客户端的工作时序图来回答下这个问题：

![](/img/nio server.png)  
上图是：JDK NIO 服务端创建和通信序列图

即便抛开代码和NIO类库复杂性不谈，一个高性能、高可靠性的NIO服务端开发和维护成本都是非常高的，开发者需要具有丰富的NIO编程经验和网络维护经验，很多时候甚至需要通过抓包来定位问题。也许开发出一套NIO程序需要1个月，但是它的稳定很可能需要1年甚至更长的时间，这也就是为什么我不建议直接使用JDK NIO类库进行通信开发的一个重要原因。
下面再一起看下JDK NIO客户端的通信时序图：它同样非常复杂。  
![](/img/jdk nio.png)

## 5.为什么要选择Netty框架
---
Netty是业界最流行的NIO框架之一，它的健壮性、功能、性能、可定制性和可扩展性在同类框架中都是首屈一指的，它已经得到成百上千的商用项目验证，例如Hadoop的RPC框架Avro使用Netty作为通信框架。很多其它业界主流的RPC和分布式服务框架，也使用Netty来构建高性能的异步通信能力。
Netty的优点总结如下：  

- API使用简单，开发门槛低；
- 功能强大，预置了多种编解码功能，支持多种主流协议；
- 定制能力强，可以通过ChannelHandler对通信框架进行灵活的扩展；
- 性能高，通过与其它业界主流的NIO框架对比，Netty的综合性能最优；
- 成熟、稳定，Netty修复了已经发现的所有JDK NIO BUG，业务开发人员不需要再为NIO的BUG而烦恼；
- 社区活跃，版本迭代周期短，发现的BUG可以被及时修复，同时，更多的新功能会被加入；
- 经历了大规模的商业应用考验，质量得到验证。在互联网、大数据、网络游戏、企业应用、电信软件等众多行业得到成功商用，证明了它完全满足不同行业的商用标准。

正是因为这些优点，Netty逐渐成为Java NIO编程的首选框架。

## 6.听说Netty各版本的API变化比较频繁，我该如何选择版本
---
事实上，Netty各版本之间的API变更并没有一些人讲的那么可怕，最大的变更就是3.X系列到4.X/5.X的变更，Netty不仅仅重构了包路径，对于之前一直想改但是考虑到前向兼容性没改的类库进行了优化和修改。这次变更的主要原因是Netty脱离了Jboss独立发展，这对于Netty的长远发展是件好事。  

在我看来，Netty4.X系列版本的架构和API设计更加合理，同时，它提供了更多新的特性。因此，我个人建议用户可以选择4.X系列版本，以免未来升级遇到困难和问题。  

对于已经使用3.X系列版本的用户，如果现有功能已经满足需求，短期内暂时不需要升级。如果需要使用更多新特性和功能，建议在充分评估之后进行升级，这可能需要一些工作量。  

由于Netty5最新版本仍处于测试阶段，从学习和研究角度可以试用一下，Netty5相比于Netty4是前向兼容的，因此，未来用户升级到Netty5会更加容易。

## 7.Netty和Mina 我究竟该选择哪个
---
根据我的经验，无论选择哪个，都是个正确的选择。两者各有千秋，Netty在内存管理方面更胜一筹，综合性能也更优。但是，API变更的管理和兼容性做的不是太好。相比于Netty，Mina的前向兼容性、内聚的可维护性功能更多，例如JMX的集成、性能统计、状态机等。

建议用户可以根据自己对两者的熟悉程度和实际项目需求，做出最佳选择。如果你锁定了两者，本身就意味着你做出了正确选择，不需要再纠结于选择哪个而和领导、同事吵得面红耳赤。

## 8.Netty使用简单吗
---
Netty的基础开发和应用非常简单，开发一个Echo服务端只需要28行代码，开发对应的Echo客户端只需要26行代码！

但是，如果你要利用它进行私有协议栈开发、HTTP服务端和客户端开发等，仍然需要深入的学习Netty的一些高级类库和功能，了解Netty的设计原理。只有这样，才能恰到好处的使用Netty，为项目和公司带来更大的价值。

## 9.有没有Netty相关的书籍供学习和参考
---
2014年5-6月，中国第一本学习Netty的教材《Netty权威指南》将由电子工业出版社博文视点出版。
全书共23个章节，从JAVA IO的历史演进讲起，包括NIO基础入门、Netty基础入门、Netty编解码框架的使用和开发、UDP开发、异步文件传输、基于Netty的异步HTTP协议栈开发和应用、半包解码器的定制和使用、私有协议栈的设计和开发、行业应用、架构剖析、核心类库的功能讲解和源码分析等。
无论你是初学者，还是NIO高手，都能从本书中汲取营养，为掌握乃至精通Netty提供快捷通道。

## 10.我是大学毕业生，正在学习Java，听说掌握Netty等NIO框架找工作会相对容易一些，是真的吗
---
从我的经验和Netty行业应用来看，前景无限好！下面我们通过谷歌搜索简单看下现在市场对Netty和Mina的需求。  

下面是我的一小部分搜索结果：  
![](/img/netty-search.png)  
由于搜索结果太多，我就不一一枚举。市场上对Netty和Mina的需求非常旺盛，而且相对高端，所以薪水会更高些。例如，深圳某国企开出的薪水在20W以上，上不封顶，这足以说明Netty的“高大上”。
就个人而言，我无意冒犯或者贬低其它技术，但是，相比于WEB前台开发/精通Spring框架等，精通和熟悉Netty的人毕竟是非常少的。一个原因是异步网络编程的复杂性，另一个原因是中国的NIO编程正处于方兴未艾阶段，市场需求在逐渐增大，开始出现井喷。但是精通NIO编程和具有相关经验的人太少，导致供需不平衡，这也是最近Netty越来越火的一个重要原因，市场需求决定技术导向。

**【作者简介】**李林锋：现就职于某世界五百强通信公司，拥有5年NIO设计、开发和维护经验，长期从事高性能通信软件的架构设计和开发工作，设计的多款平台软件已经成功在N个商业局点稳定运行多年。
联系方式：新浪微博：@Nettying  邮箱：neu_lilinfeng@sina.com

转载自：[http://mp.weixin.qq.com/s?__biz=MjM5MzA0ODkyMA==&mid=200882593&idx=1&sn=a6ac2c3f3abcaeda478abfc7cd6b1e4f](http://mp.weixin.qq.com/s?__biz=MjM5MzA0ODkyMA==&mid=200882593&idx=1&sn=a6ac2c3f3abcaeda478abfc7cd6b1e4f "http://mp.weixin.qq.com/s?__biz=MjM5MzA0ODkyMA==&mid=200882593&idx=1&sn=a6ac2c3f3abcaeda478abfc7cd6b1e4f")
